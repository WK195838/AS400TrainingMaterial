# ç¬¬å…­é€±ï¼šå°ˆæ¡ˆå¯¦æˆ°é–‹ç™¼ - å®Œæ•´æ•™æ

## ğŸ“š æœ¬é€±å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬é€±å­¸ç¿’å¾Œï¼Œå­¸å“¡å°‡èƒ½å¤ ï¼š
- æ•´åˆå‰é¢æ‰€å­¸çš„æ‰€æœ‰æŠ€è¡“å»ºç«‹å®Œæ•´çš„Webæ‡‰ç”¨ç¨‹å¼
- å¯¦ä½œå®Œæ•´çš„é›»å•†ç³»çµ±æ ¸å¿ƒåŠŸèƒ½
- æŒæ¡å°ˆæ¡ˆæ¶æ§‹è¨­è¨ˆå’Œæ¨¡çµ„åŒ–é–‹ç™¼
- é‹ç”¨æœ€ä½³å¯¦å‹™é€²è¡Œç¨‹å¼ç¢¼çµ„ç¹”å’Œç®¡ç†
- å¯¦ä½œå®‰å…¨æ€§ã€æ•ˆèƒ½å„ªåŒ–å’Œä½¿ç”¨è€…é«”é©—
- å…·å‚™å®Œæ•´çš„å…¨ç«¯Webé–‹ç™¼èƒ½åŠ›

---

## ğŸš€ ç¬¬ä¸€ç¯€ï¼šå°ˆæ¡ˆæ¶æ§‹è¨­è¨ˆ

### 1.1 é›»å•†ç³»çµ±æ¶æ§‹è¦åŠƒ

#### 1.1.1 ç³»çµ±æ¶æ§‹åœ–

```
é›»å•†ç³»çµ±æ•´é«”æ¶æ§‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å‰ç«¯å±¤ (Presentation)         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ éŸ¿æ‡‰å¼Webç•Œé¢ (Bootstrap + JS)    â”‚ â”‚
â”‚ â”‚ â€¢ ç®¡ç†å¾Œå°ç•Œé¢                     â”‚ â”‚
â”‚ â”‚ â€¢ RESTful APIæ¥å£                  â”‚ â”‚
â”‚ â”‚ â€¢ ç§»å‹•ç«¯å‹å¥½ç•Œé¢                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†• HTTP/HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ‡‰ç”¨æœå‹™å±¤ (Application)        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ ASP.NET Core MVC                 â”‚ â”‚
â”‚ â”‚ â€¢ ä¾è³´æ³¨å…¥å®¹å™¨                     â”‚ â”‚
â”‚ â”‚ â€¢ èº«åˆ†é©—è­‰èˆ‡æˆæ¬Š                   â”‚ â”‚
â”‚ â”‚ â€¢ ä¸­ä»‹è»Ÿé«”ç®¡ç·š                     â”‚ â”‚
â”‚ â”‚ â€¢ AutoMapperå°è±¡æ˜ å°„               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†• Service Layer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ¥­å‹™é‚è¼¯å±¤ (Business Logic)     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ ç”¢å“ç®¡ç†æœå‹™                     â”‚ â”‚
â”‚ â”‚ â€¢ è¨‚å–®è™•ç†æœå‹™                     â”‚ â”‚
â”‚ â”‚ â€¢ è³¼ç‰©è»Šç®¡ç†                       â”‚ â”‚
â”‚ â”‚ â”‚ æ”¯ä»˜è™•ç†æœå‹™                     â”‚ â”‚
â”‚ â”‚ â€¢ åº«å­˜ç®¡ç†æœå‹™                     â”‚ â”‚
â”‚ â”‚ â€¢ æœƒå“¡ç®¡ç†æœå‹™                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†• Repository Pattern
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         è³‡æ–™å­˜å–å±¤ (Data Access)        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ Entity Framework Core            â”‚ â”‚
â”‚ â”‚ â€¢ Repository Pattern              â”‚ â”‚
â”‚ â”‚ â€¢ Unit of Work Pattern            â”‚ â”‚
â”‚ â”‚ â€¢ è³‡æ–™åº«é€£æ¥æ±                      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†• Database Connection
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            è³‡æ–™åº«å±¤ (Database)          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ SQL Server è³‡æ–™åº«                â”‚ â”‚
â”‚ â”‚ â€¢ Redis å¿«å–ç³»çµ±                   â”‚ â”‚
â”‚ â”‚ â€¢ æª”æ¡ˆå„²å­˜ç³»çµ±                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.1.2 å°ˆæ¡ˆçµæ§‹è¨­è¨ˆ

```csharp
/*
ECommerceApp å°ˆæ¡ˆçµæ§‹ï¼š

ECommerceApp/
â”œâ”€â”€ ECommerceApp.Web/              // ä¸»è¦Webæ‡‰ç”¨ç¨‹å¼
â”‚   â”œâ”€â”€ Controllers/               // MVCæ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ HomeController.cs
â”‚   â”‚   â”œâ”€â”€ ProductController.cs
â”‚   â”‚   â”œâ”€â”€ CartController.cs
â”‚   â”‚   â”œâ”€â”€ OrderController.cs
â”‚   â”‚   â”œâ”€â”€ AccountController.cs
â”‚   â”‚   â””â”€â”€ AdminController.cs
â”‚   â”œâ”€â”€ Views/                     // Razorè¦–åœ–
â”‚   â”‚   â”œâ”€â”€ Home/
â”‚   â”‚   â”œâ”€â”€ Product/
â”‚   â”‚   â”œâ”€â”€ Cart/
â”‚   â”‚   â”œâ”€â”€ Order/
â”‚   â”‚   â”œâ”€â”€ Account/
â”‚   â”‚   â”œâ”€â”€ Admin/
â”‚   â”‚   â””â”€â”€ Shared/
â”‚   â”œâ”€â”€ ViewModels/               // è¦–åœ–æ¨¡å‹
â”‚   â”œâ”€â”€ wwwroot/                  // éœæ…‹è³‡æº
â”‚   â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ lib/
â”‚   â”œâ”€â”€ Program.cs                // æ‡‰ç”¨ç¨‹å¼é€²å…¥é»
â”‚   â”œâ”€â”€ appsettings.json         // çµ„æ…‹è¨­å®š
â”‚   â””â”€â”€ web.config
â”‚
â”œâ”€â”€ ECommerceApp.Core/            // æ ¸å¿ƒæ¥­å‹™é‚è¼¯
â”‚   â”œâ”€â”€ Entities/                 // å¯¦é«”é¡åˆ¥
â”‚   â”‚   â”œâ”€â”€ Product.cs
â”‚   â”‚   â”œâ”€â”€ Category.cs
â”‚   â”‚   â”œâ”€â”€ Customer.cs
â”‚   â”‚   â”œâ”€â”€ Order.cs
â”‚   â”‚   â”œâ”€â”€ OrderItem.cs
â”‚   â”‚   â””â”€â”€ ShoppingCart.cs
â”‚   â”œâ”€â”€ Interfaces/               // æœå‹™ä»‹é¢
â”‚   â”‚   â”œâ”€â”€ IProductService.cs
â”‚   â”‚   â”œâ”€â”€ IOrderService.cs
â”‚   â”‚   â”œâ”€â”€ ICartService.cs
â”‚   â”‚   â””â”€â”€ IEmailService.cs
â”‚   â”œâ”€â”€ Services/                 // æ¥­å‹™æœå‹™å¯¦ä½œ
â”‚   â”‚   â”œâ”€â”€ ProductService.cs
â”‚   â”‚   â”œâ”€â”€ OrderService.cs
â”‚   â”‚   â”œâ”€â”€ CartService.cs
â”‚   â”‚   â””â”€â”€ EmailService.cs
â”‚   â”œâ”€â”€ DTOs/                     // è³‡æ–™å‚³è¼¸ç‰©ä»¶
â”‚   â””â”€â”€ Exceptions/               // è‡ªè¨‚ä¾‹å¤–
â”‚
â”œâ”€â”€ ECommerceApp.Infrastructure/  // åŸºç¤è¨­æ–½å±¤
â”‚   â”œâ”€â”€ Data/                     // è³‡æ–™å­˜å–
â”‚   â”‚   â”œâ”€â”€ ApplicationDbContext.cs
â”‚   â”‚   â”œâ”€â”€ Repositories/
â”‚   â”‚   â”‚   â”œâ”€â”€ IRepository.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ Repository.cs
â”‚   â”‚   â”‚   â””â”€â”€ UnitOfWork.cs
â”‚   â”‚   â””â”€â”€ Configurations/       // EFè¨­å®š
â”‚   â”œâ”€â”€ Services/                 // å¤–éƒ¨æœå‹™
â”‚   â”‚   â”œâ”€â”€ EmailService.cs
â”‚   â”‚   â”œâ”€â”€ FileService.cs
â”‚   â”‚   â””â”€â”€ PaymentService.cs
â”‚   â””â”€â”€ Extensions/               // æ“´å±•æ–¹æ³•
â”‚
â””â”€â”€ ECommerceApp.Tests/           // æ¸¬è©¦å°ˆæ¡ˆ
    â”œâ”€â”€ UnitTests/
    â”œâ”€â”€ IntegrationTests/
    â””â”€â”€ TestData/
*/

using Microsoft.EntityFrameworkCore;
using ECommerceApp.Core.Interfaces;
using ECommerceApp.Core.Services;
using ECommerceApp.Infrastructure.Data;
using ECommerceApp.Infrastructure.Services;

namespace ECommerceApp.Web
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var builder = WebApplication.CreateBuilder(args);
            
            // è¨»å†Šæœå‹™
            ConfigureServices(builder.Services, builder.Configuration);
            
            var app = builder.Build();
            
            // è¨­å®šä¸­ä»‹è»Ÿé«”ç®¡ç·š
            ConfigureMiddleware(app);
            
            // åˆå§‹åŒ–è³‡æ–™åº«
            await InitializeDatabaseAsync(app);
            
            app.Run();
        }
        
        private static void ConfigureServices(IServiceCollection services, IConfiguration configuration)
        {
            // è³‡æ–™åº«æœå‹™
            services.AddDbContext<ApplicationDbContext>(options =>
                options.UseSqlServer(configuration.GetConnectionString("DefaultConnection"),
                    b => b.MigrationsAssembly("ECommerceApp.Infrastructure")));
            
            // Identityæœå‹™
            services.AddDefaultIdentity<ApplicationUser>(options =>
            {
                // å¯†ç¢¼è¦æ±‚
                options.Password.RequireDigit = true;
                options.Password.RequiredLength = 8;
                options.Password.RequireNonAlphanumeric = false;
                options.Password.RequireUppercase = true;
                options.Password.RequireLowercase = true;
                
                // ä½¿ç”¨è€…è¦æ±‚
                options.User.RequireUniqueEmail = true;
                
                // ç™»å…¥è¦æ±‚
                options.SignIn.RequireConfirmedEmail = false;
                options.SignIn.RequireConfirmedAccount = false;
            })
            .AddRoles<IdentityRole>()
            .AddEntityFrameworkStores<ApplicationDbContext>();
            
            // Repositoryå’ŒUnit of Work
            services.AddScoped(typeof(IRepository<>), typeof(Repository<>));
            services.AddScoped<IUnitOfWork, UnitOfWork>();
            
            // æ¥­å‹™æœå‹™
            services.AddScoped<IProductService, ProductService>();
            services.AddScoped<ICategoryService, CategoryService>();
            services.AddScoped<ICartService, CartService>();
            services.AddScoped<IOrderService, OrderService>();
            services.AddScoped<ICustomerService, CustomerService>();
            services.AddScoped<IEmailService, EmailService>();
            services.AddScoped<IFileService, FileService>();
            services.AddScoped<IPaymentService, PaymentService>();
            
            // AutoMapper
            services.AddAutoMapper(typeof(Program), typeof(MappingProfile));
            
            // å¿«å–æœå‹™
            services.AddMemoryCache();
            services.AddStackExchangeRedisCache(options =>
            {
                options.Configuration = configuration.GetConnectionString("Redis");
            });
            
            // HTTPå®¢æˆ¶ç«¯
            services.AddHttpClient();
            
            // MVCæœå‹™
            services.AddControllersWithViews(options =>
            {
                // å…¨åŸŸç¯©é¸å™¨
                options.Filters.Add<GlobalExceptionFilter>();
                options.Filters.Add<ModelStateValidationFilter>();
            });
            
            // APIæœå‹™
            services.AddEndpointsApiExplorer();
            services.AddSwaggerGen();
            
            // å…¶ä»–æœå‹™
            services.AddAntiforgery(options =>
            {
                options.HeaderName = "X-CSRF-TOKEN";
            });
            
            // è‡ªè¨‚çµ„æ…‹
            services.Configure<EmailSettings>(configuration.GetSection("EmailSettings"));
            services.Configure<PaymentSettings>(configuration.GetSection("PaymentSettings"));
            services.Configure<FileUploadSettings>(configuration.GetSection("FileUploadSettings"));
        }
        
        private static void ConfigureMiddleware(WebApplication app)
        {
            // é–‹ç™¼ç’°å¢ƒè¨­å®š
            if (app.Environment.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
                app.UseSwagger();
                app.UseSwaggerUI();
            }
            else
            {
                app.UseExceptionHandler("/Home/Error");
                app.UseHsts();
            }
            
            // å®‰å…¨æ€§ä¸­ä»‹è»Ÿé«”
            app.UseHttpsRedirection();
            app.UseSecurityHeaders();
            
            // éœæ…‹æª”æ¡ˆ
            app.UseStaticFiles();
            
            // è·¯ç”±
            app.UseRouting();
            
            // èº«åˆ†é©—è­‰å’Œæˆæ¬Š
            app.UseAuthentication();
            app.UseAuthorization();
            
            // è‡ªè¨‚ä¸­ä»‹è»Ÿé«”
            app.UseRequestLogging();
            app.UsePerformanceMonitoring();
            
            // MVCè·¯ç”±
            app.MapControllerRoute(
                name: "areas",
                pattern: "{area:exists}/{controller=Home}/{action=Index}/{id?}");
                
            app.MapControllerRoute(
                name: "default",
                pattern: "{controller=Home}/{action=Index}/{id?}");
            
            // APIè·¯ç”±
            app.MapControllers();
            
            // Razor Pages (å¦‚æœéœ€è¦)
            app.MapRazorPages();
        }
        
        private static async Task InitializeDatabaseAsync(WebApplication app)
        {
            using (var scope = app.Services.CreateScope())
            {
                var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
                var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();
                var roleManager = scope.ServiceProvider.GetRequiredService<RoleManager<IdentityRole>>();
                
                // åŸ·è¡Œè³‡æ–™åº«é·ç§»
                await context.Database.MigrateAsync();
                
                // åˆå§‹åŒ–ç¨®å­è³‡æ–™
                await SeedDataAsync(context, userManager, roleManager);
            }
        }
        
        private static async Task SeedDataAsync(
            ApplicationDbContext context,
            UserManager<ApplicationUser> userManager,
            RoleManager<IdentityRole> roleManager)
        {
            // å»ºç«‹è§’è‰²
            var roles = new[] { "Admin", "Manager", "Customer" };
            foreach (var roleName in roles)
            {
                if (!await roleManager.RoleExistsAsync(roleName))
                {
                    await roleManager.CreateAsync(new IdentityRole(roleName));
                }
            }
            
            // å»ºç«‹ç®¡ç†å“¡å¸³è™Ÿ
            var adminEmail = "admin@ecommerce.com";
            var adminUser = await userManager.FindByEmailAsync(adminEmail);
            if (adminUser == null)
            {
                adminUser = new ApplicationUser
                {
                    UserName = adminEmail,
                    Email = adminEmail,
                    EmailConfirmed = true,
                    FirstName = "System",
                    LastName = "Administrator"
                };
                
                var result = await userManager.CreateAsync(adminUser, "Admin123!");
                if (result.Succeeded)
                {
                    await userManager.AddToRoleAsync(adminUser, "Admin");
                }
            }
            
            // åˆå§‹åŒ–ç”¢å“é¡åˆ¥
            if (!context.Categories.Any())
            {
                var categories = new[]
                {
                    new Category { Name = "é›»å­ç”¢å“", Description = "æ‰‹æ©Ÿã€é›»è…¦ã€ç›¸æ©Ÿç­‰é›»å­ç”¢å“" },
                    new Category { Name = "æœé£¾é…ä»¶", Description = "ç”·å¥³æœé£¾ã€é‹å­ã€åŒ…åŒ…ç­‰" },
                    new Category { Name = "å®¶å±…ç”¨å“", Description = "å®¶å…·ã€è£é£¾å“ã€æ¸…æ½”ç”¨å“ç­‰" },
                    new Category { Name = "é‹å‹•å¥èº«", Description = "é‹å‹•å™¨æã€å¥èº«ç”¨å“ã€æˆ¶å¤–ç”¨å“" },
                    new Category { Name = "æ›¸ç±æ–‡å…·", Description = "æ›¸ç±ã€æ–‡å…·ç”¨å“ã€è¾¦å…¬ç”¨å“" }
                };
                
                context.Categories.AddRange(categories);
                await context.SaveChangesAsync();
            }
            
            // åˆå§‹åŒ–ç¤ºç¯„ç”¢å“
            if (!context.Products.Any())
            {
                var electronics = context.Categories.First(c => c.Name == "é›»å­ç”¢å“");
                var clothing = context.Categories.First(c => c.Name == "æœé£¾é…ä»¶");
                
                var products = new[]
                {
                    new Product
                    {
                        Name = "æ™ºæ…§å‹æ‰‹æ©Ÿ Pro Max",
                        Description = "æœ€æ–°æ——è‰¦æ™ºæ…§å‹æ‰‹æ©Ÿï¼Œæ­è¼‰é ‚ç´šè™•ç†å™¨å’Œç›¸æ©Ÿç³»çµ±",
                        Price = 32900,
                        CategoryId = electronics.Id,
                        StockQuantity = 50,
                        SKU = "PHONE001",
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow
                    },
                    new Product
                    {
                        Name = "ç„¡ç·šè—ç‰™è€³æ©Ÿ",
                        Description = "é«˜å“è³ªç„¡ç·šè€³æ©Ÿï¼Œæä¾›å“è¶ŠéŸ³è³ªå’Œé•·æ™‚é–“çºŒèˆª",
                        Price = 4990,
                        CategoryId = electronics.Id,
                        StockQuantity = 100,
                        SKU = "AUDIO001",
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow
                    },
                    new Product
                    {
                        Name = "ä¼‘é–’Tæ¤",
                        Description = "100%ç´”æ£‰æè³ªï¼Œèˆ’é©é€æ°£ï¼Œå¤šè‰²å¯é¸",
                        Price = 590,
                        CategoryId = clothing.Id,
                        StockQuantity = 200,
                        SKU = "CLOTH001",
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow
                    }
                };
                
                context.Products.AddRange(products);
                await context.SaveChangesAsync();
            }
        }
    }
}
```

---

## ğŸ›’ ç¬¬äºŒç¯€ï¼šæ ¸å¿ƒåŠŸèƒ½å¯¦ä½œ

### 2.1 ç”¢å“ç®¡ç†ç³»çµ±

#### 2.1.1 ç”¢å“å¯¦é«”å’Œè³‡æ–™æ¨¡å‹

```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace ECommerceApp.Core.Entities
{
    // ç”¢å“å¯¦é«”
    public class Product : BaseEntity
    {
        [Required]
        [MaxLength(200)]
        public string Name { get; set; }
        
        [MaxLength(50)]
        public string SKU { get; set; }
        
        public string Description { get; set; }
        
        [Column(TypeName = "decimal(18,2)")]
        public decimal Price { get; set; }
        
        [Column(TypeName = "decimal(18,2)")]
        public decimal? OriginalPrice { get; set; }
        
        public int StockQuantity { get; set; }
        public int ReorderLevel { get; set; } = 10;
        
        // ç”¢å“å±¬æ€§
        [MaxLength(100)]
        public string Brand { get; set; }
        
        [MaxLength(50)]
        public string Color { get; set; }
        
        [MaxLength(20)]
        public string Size { get; set; }
        
        [Column(TypeName = "decimal(10,3)")]
        public decimal? Weight { get; set; }
        
        [MaxLength(100)]
        public string Dimensions { get; set; }
        
        // SEOå’Œè¡ŒéŠ·
        [MaxLength(200)]
        public string MetaTitle { get; set; }
        
        [MaxLength(500)]
        public string MetaDescription { get; set; }
        
        [MaxLength(500)]
        public string Tags { get; set; }
        
        // ç‹€æ…‹ç®¡ç†
        public bool IsActive { get; set; } = true;
        public bool IsFeatured { get; set; } = false;
        public bool IsDiscontinued { get; set; } = false;
        
        // çµ±è¨ˆè³‡è¨Š
        public int ViewCount { get; set; } = 0;
        public int SalesCount { get; set; } = 0;
        public decimal AverageRating { get; set; } = 0;
        public int ReviewCount { get; set; } = 0;
        
        // é—œè¯
        public int CategoryId { get; set; }
        public virtual Category Category { get; set; }
        
        public virtual ICollection<ProductImage> Images { get; set; } = new List<ProductImage>();
        public virtual ICollection<ProductReview> Reviews { get; set; } = new List<ProductReview>();
        public virtual ICollection<OrderItem> OrderItems { get; set; } = new List<OrderItem>();
        public virtual ICollection<CartItem> CartItems { get; set; } = new List<CartItem>();
        public virtual ICollection<WishlistItem> WishlistItems { get; set; } = new List<WishlistItem>();
        
        // è¨ˆç®—å±¬æ€§
        [NotMapped]
        public bool IsOnSale => OriginalPrice.HasValue && OriginalPrice > Price;
        
        [NotMapped]
        public decimal DiscountPercentage => IsOnSale ? 
            Math.Round(((OriginalPrice.Value - Price) / OriginalPrice.Value) * 100, 2) : 0;
        
        [NotMapped]
        public bool IsInStock => StockQuantity > 0;
        
        [NotMapped]
        public bool IsLowStock => StockQuantity <= ReorderLevel && StockQuantity > 0;
        
        [NotMapped]
        public string MainImageUrl => Images?.FirstOrDefault(i => i.IsMain)?.ImageUrl ?? "/images/no-image.jpg";
    }
    
    // ç”¢å“åœ–ç‰‡
    public class ProductImage : BaseEntity
    {
        [Required]
        [MaxLength(500)]
        public string ImageUrl { get; set; }
        
        [MaxLength(200)]
        public string AltText { get; set; }
        
        public bool IsMain { get; set; } = false;
        public int DisplayOrder { get; set; } = 0;
        
        // é—œè¯
        public int ProductId { get; set; }
        public virtual Product Product { get; set; }
    }
    
    // ç”¢å“è©•è«–
    public class ProductReview : BaseEntity
    {
        [Range(1, 5)]
        public int Rating { get; set; }
        
        [MaxLength(200)]
        public string Title { get; set; }
        
        public string ReviewText { get; set; }
        
        public bool IsApproved { get; set; } = false;
        public int HelpfulCount { get; set; } = 0;
        
        // é—œè¯
        public int ProductId { get; set; }
        public virtual Product Product { get; set; }
        
        public string CustomerId { get; set; }
        public virtual ApplicationUser Customer { get; set; }
    }
    
    // ç”¢å“é¡åˆ¥
    public class Category : BaseEntity
    {
        [Required]
        [MaxLength(100)]
        public string Name { get; set; }
        
        public string Description { get; set; }
        
        [MaxLength(500)]
        public string ImageUrl { get; set; }
        
        public bool IsActive { get; set; } = true;
        public int DisplayOrder { get; set; } = 0;
        
        // éšå±¤å¼é¡åˆ¥
        public int? ParentCategoryId { get; set; }
        public virtual Category ParentCategory { get; set; }
        public virtual ICollection<Category> SubCategories { get; set; } = new List<Category>();
        
        // é—œè¯
        public virtual ICollection<Product> Products { get; set; } = new List<Product>();
        
        // è¨ˆç®—å±¬æ€§
        [NotMapped]
        public int ProductCount => Products?.Count(p => p.IsActive) ?? 0;
    }
    
    // åŸºåº•å¯¦é«”é¡åˆ¥
    public abstract class BaseEntity
    {
        public int Id { get; set; }
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public DateTime? UpdatedAt { get; set; }
        public string CreatedBy { get; set; }
        public string UpdatedBy { get; set; }
    }
}
```

#### 2.1.2 ç”¢å“æœå‹™å¯¦ä½œ

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Caching.Memory;
using ECommerceApp.Core.Entities;
using ECommerceApp.Core.Interfaces;
using ECommerceApp.Core.DTOs;

namespace ECommerceApp.Core.Services
{
    public class ProductService : IProductService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly IMemoryCache _cache;
        private readonly IFileService _fileService;
        private readonly ILogger<ProductService> _logger;
        
        public ProductService(
            IUnitOfWork unitOfWork,
            IMemoryCache cache,
            IFileService fileService,
            ILogger<ProductService> logger)
        {
            _unitOfWork = unitOfWork;
            _cache = cache;
            _fileService = fileService;
            _logger = logger;
        }
        
        // å–å¾—ç”¢å“æ¸…å–®ï¼ˆåˆ†é å’Œç¯©é¸ï¼‰
        public async Task<PagedResult<Product>> GetProductsAsync(ProductSearchCriteria criteria)
        {
            var query = _unitOfWork.Repository<Product>().GetQueryable()
                .Include(p => p.Category)
                .Include(p => p.Images)
                .Where(p => p.IsActive);
            
            // æœå°‹æ¢ä»¶
            if (!string.IsNullOrWhiteSpace(criteria.SearchTerm))
            {
                var searchTerm = criteria.SearchTerm.ToLower();
                query = query.Where(p => 
                    p.Name.ToLower().Contains(searchTerm) ||
                    p.Description.ToLower().Contains(searchTerm) ||
                    p.Tags.ToLower().Contains(searchTerm));
            }
            
            // é¡åˆ¥ç¯©é¸
            if (criteria.CategoryId.HasValue)
            {
                query = query.Where(p => p.CategoryId == criteria.CategoryId.Value);
            }
            
            // åƒ¹æ ¼ç¯„åœç¯©é¸
            if (criteria.MinPrice.HasValue)
            {
                query = query.Where(p => p.Price >= criteria.MinPrice.Value);
            }
            
            if (criteria.MaxPrice.HasValue)
            {
                query = query.Where(p => p.Price <= criteria.MaxPrice.Value);
            }
            
            // å“ç‰Œç¯©é¸
            if (!string.IsNullOrWhiteSpace(criteria.Brand))
            {
                query = query.Where(p => p.Brand == criteria.Brand);
            }
            
            // ç‰¹è‰²ç”¢å“ç¯©é¸
            if (criteria.IsFeatured.HasValue)
            {
                query = query.Where(p => p.IsFeatured == criteria.IsFeatured.Value);
            }
            
            // åº«å­˜ç‹€æ…‹ç¯©é¸
            if (criteria.InStock.HasValue && criteria.InStock.Value)
            {
                query = query.Where(p => p.StockQuantity > 0);
            }
            
            // æ’åº
            query = criteria.SortBy?.ToLower() switch
            {
                "name" => criteria.SortDirection == "desc" 
                    ? query.OrderByDescending(p => p.Name)
                    : query.OrderBy(p => p.Name),
                "price" => criteria.SortDirection == "desc"
                    ? query.OrderByDescending(p => p.Price)
                    : query.OrderBy(p => p.Price),
                "created" => criteria.SortDirection == "desc"
                    ? query.OrderByDescending(p => p.CreatedAt)
                    : query.OrderBy(p => p.CreatedAt),
                "rating" => criteria.SortDirection == "desc"
                    ? query.OrderByDescending(p => p.AverageRating)
                    : query.OrderBy(p => p.AverageRating),
                "popularity" => query.OrderByDescending(p => p.ViewCount),
                _ => query.OrderByDescending(p => p.CreatedAt)
            };
            
            // åˆ†é 
            var totalCount = await query.CountAsync();
            var products = await query
                .Skip((criteria.Page - 1) * criteria.PageSize)
                .Take(criteria.PageSize)
                .ToListAsync();
            
            return new PagedResult<Product>
            {
                Items = products,
                TotalCount = totalCount,
                Page = criteria.Page,
                PageSize = criteria.PageSize,
                TotalPages = (int)Math.Ceiling(totalCount / (double)criteria.PageSize)
            };
        }
        
        // å–å¾—å–®ä¸€ç”¢å“è©³æƒ…
        public async Task<Product> GetProductByIdAsync(int id)
        {
            var cacheKey = $"product_{id}";
            
            if (_cache.TryGetValue(cacheKey, out Product cachedProduct))
            {
                return cachedProduct;
            }
            
            var product = await _unitOfWork.Repository<Product>().GetQueryable()
                .Include(p => p.Category)
                .Include(p => p.Images.OrderBy(i => i.DisplayOrder))
                .Include(p => p.Reviews.Where(r => r.IsApproved))
                    .ThenInclude(r => r.Customer)
                .FirstOrDefaultAsync(p => p.Id == id && p.IsActive);
            
            if (product != null)
            {
                // å¿«å–30åˆ†é˜
                _cache.Set(cacheKey, product, TimeSpan.FromMinutes(30));
            }
            
            return product;
        }
        
        // å»ºç«‹æ–°ç”¢å“
        public async Task<Product> CreateProductAsync(CreateProductDto dto, string createdBy)
        {
            try
            {
                // æª¢æŸ¥SKUæ˜¯å¦é‡è¤‡
                if (!string.IsNullOrWhiteSpace(dto.SKU))
                {
                    var existingSku = await _unitOfWork.Repository<Product>()
                        .GetQueryable()
                        .AnyAsync(p => p.SKU == dto.SKU);
                    
                    if (existingSku)
                    {
                        throw new BusinessException($"SKU '{dto.SKU}' å·²å­˜åœ¨");
                    }
                }
                
                var product = new Product
                {
                    Name = dto.Name,
                    SKU = dto.SKU,
                    Description = dto.Description,
                    Price = dto.Price,
                    OriginalPrice = dto.OriginalPrice,
                    StockQuantity = dto.StockQuantity,
                    ReorderLevel = dto.ReorderLevel,
                    Brand = dto.Brand,
                    Color = dto.Color,
                    Size = dto.Size,
                    Weight = dto.Weight,
                    Dimensions = dto.Dimensions,
                    MetaTitle = dto.MetaTitle,
                    MetaDescription = dto.MetaDescription,
                    Tags = dto.Tags,
                    CategoryId = dto.CategoryId,
                    IsFeatured = dto.IsFeatured,
                    CreatedBy = createdBy
                };
                
                // è™•ç†åœ–ç‰‡ä¸Šå‚³
                if (dto.ImageFiles?.Any() == true)
                {
                    var images = await ProcessProductImagesAsync(